{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n/*\nCopyright 2017 - 2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\nLicensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with the License. A copy of the License is located at\n    http://aws.amazon.com/apache2.0/\nor in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and limitations under the License.\n*/\n\nglobal.Buffer = global.Buffer || require('buffer').Buffer; // Required for aws sigv4 signing\n\nvar url = require('url'),\n    crypto = require('aws-sdk/global').util.crypto;\n\nvar encrypt = function (key, src, encoding) {\n  if (encoding === void 0) {\n    encoding = '';\n  }\n\n  return crypto.lib.createHmac('sha256', key).update(src, 'utf8').digest(encoding);\n};\n\nvar hash = function (src) {\n  src = src || '';\n  return crypto.createHash('sha256').update(src, 'utf8').digest('hex');\n};\n/**\n* @private\n* Create canonical headers\n*\n<pre>\nCanonicalHeaders =\n    CanonicalHeadersEntry0 + CanonicalHeadersEntry1 + ... + CanonicalHeadersEntryN\nCanonicalHeadersEntry =\n    Lowercase(HeaderName) + ':' + Trimall(HeaderValue) + '\\n'\n</pre>\n*/\n\n\nvar canonical_headers = function (headers) {\n  if (!headers || Object.keys(headers).length === 0) {\n    return '';\n  }\n\n  return Object.keys(headers).map(function (key) {\n    return {\n      key: key.toLowerCase(),\n      value: headers[key] ? headers[key].trim().replace(/\\s+/g, ' ') : ''\n    };\n  }).sort(function (a, b) {\n    return a.key < b.key ? -1 : 1;\n  }).map(function (item) {\n    return item.key + ':' + item.value;\n  }).join('\\n') + '\\n';\n};\n/**\n* List of header keys included in the canonical headers.\n* @access private\n*/\n\n\nvar signed_headers = function (headers) {\n  return Object.keys(headers).map(function (key) {\n    return key.toLowerCase();\n  }).sort().join(';');\n};\n/**\n* @private\n* Create canonical request\n* Refer to {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-create-canonical-request.html|Create a Canonical Request}\n*\n<pre>\nCanonicalRequest =\n    HTTPRequestMethod + '\\n' +\n    CanonicalURI + '\\n' +\n    CanonicalQueryString + '\\n' +\n    CanonicalHeaders + '\\n' +\n    SignedHeaders + '\\n' +\n    HexEncode(Hash(RequestPayload))\n</pre>\n*/\n\n\nvar canonical_request = function (request) {\n  var url_info = url.parse(request.url);\n  return [request.method || '/', url_info.path, url_info.query, canonical_headers(request.headers), signed_headers(request.headers), hash(request.body)].join('\\n');\n};\n\nvar parse_service_info = function (request) {\n  var url_info = url.parse(request.url),\n      host = url_info.host;\n  var matched = host.match(/([^.]+)\\.(?:([^.]*)\\.)?amazonaws\\.com$/),\n      parsed = (matched || []).slice(1, 3);\n\n  if (parsed[1] === 'es') {\n    // Elastic Search\n    parsed = parsed.reverse();\n  }\n\n  return {\n    service: request.service || parsed[0],\n    region: request.region || parsed[1]\n  };\n};\n\nvar credential_scope = function (d_str, region, service) {\n  return [d_str, region, service, 'aws4_request'].join('/');\n};\n/**\n* @private\n* Create a string to sign\n* Refer to {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-create-string-to-sign.html|Create String to Sign}\n*\n<pre>\nStringToSign =\n    Algorithm + \\n +\n    RequestDateTime + \\n +\n    CredentialScope + \\n +\n    HashedCanonicalRequest\n</pre>\n*/\n\n\nvar string_to_sign = function (algorithm, canonical_request, dt_str, scope) {\n  return [algorithm, dt_str, scope, hash(canonical_request)].join('\\n');\n};\n/**\n* @private\n* Create signing key\n* Refer to {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-calculate-signature.html|Calculate Signature}\n*\n<pre>\nkSecret = your secret access key\nkDate = HMAC(\"AWS4\" + kSecret, Date)\nkRegion = HMAC(kDate, Region)\nkService = HMAC(kRegion, Service)\nkSigning = HMAC(kService, \"aws4_request\")\n</pre>\n*/\n\n\nvar get_signing_key = function (secret_key, d_str, service_info) {\n  if (secret_key === void 0) {\n    secret_key = '';\n  }\n\n  var k = 'AWS4' + secret_key,\n      k_date = encrypt(k, d_str),\n      k_region = encrypt(k_date, service_info.region),\n      k_service = encrypt(k_region, service_info.service),\n      k_signing = encrypt(k_service, 'aws4_request');\n  return k_signing;\n};\n\nvar get_signature = function (signing_key, str_to_sign) {\n  return encrypt(signing_key, str_to_sign, 'hex');\n};\n/**\n* @private\n* Create authorization header\n* Refer to {@link http://docs.aws.amazon.com/general/latest/gr/sigv4-add-signature-to-request.html|Add the Signing Information}\n*/\n\n\nvar get_authorization_header = function (algorithm, access_key, scope, signed_headers, signature) {\n  if (access_key === void 0) {\n    access_key = '';\n  }\n\n  return [algorithm + ' ' + 'Credential=' + access_key + '/' + scope, 'SignedHeaders=' + signed_headers, 'Signature=' + signature].join(', ');\n};\n/**\n* Sign a HTTP request, add 'Authorization' header to request param\n* @method sign\n* @memberof Signer\n* @static\n*\n* @param {object} request - HTTP request object\n<pre>\nrequest: {\n    method: GET | POST | PUT ...\n    url: ...,\n    headers: {\n        header1: ...\n    },\n    body: data\n}\n</pre>\n* @param {object} access_info - AWS access credential info\n<pre>\naccess_info: {\n    access_key: ...,\n    secret_key: ...,\n    session_token: ...\n}\n</pre>\n* @param {object} [service_info] - AWS service type and region, optional,\n*                                  if not provided then parse out from url\n<pre>\nservice_info: {\n    service: ...,\n    region: ...\n}\n</pre>\n*\n* @returns {object} Signed HTTP request\n*/\n\n\nvar sign = function (request, access_info, service_info) {\n  if (service_info === void 0) {\n    service_info = null;\n  }\n\n  request.headers = request.headers || {}; // datetime string and date string\n\n  var dt = new Date(),\n      dt_str = dt.toISOString().replace(/[:-]|\\.\\d{3}/g, ''),\n      d_str = dt_str.substr(0, 8),\n      algorithm = 'AWS4-HMAC-SHA256';\n  var url_info = url.parse(request.url);\n  request.headers['host'] = url_info.host;\n  request.headers['x-amz-date'] = dt_str;\n\n  if (access_info.session_token) {\n    request.headers['X-Amz-Security-Token'] = access_info.session_token;\n  } // Task 1: Create a Canonical Request\n\n\n  var request_str = canonical_request(request); // Task 2: Create a String to Sign\n\n  service_info = service_info || parse_service_info(request);\n  var scope = credential_scope(d_str, service_info.region, service_info.service);\n  var str_to_sign = string_to_sign(algorithm, request_str, dt_str, scope); // Task 3: Calculate the Signature\n\n  var signing_key = get_signing_key(access_info.secret_key, d_str, service_info),\n      signature = get_signature(signing_key, str_to_sign); // Task 4: Adding the Signing information to the Request\n\n  var authorization_header = get_authorization_header(algorithm, access_info.access_key, scope, signed_headers(request.headers), signature);\n  request.headers['Authorization'] = authorization_header;\n  return request;\n};\n/**\n* AWS request signer.\n* Refer to {@link http://docs.aws.amazon.com/general/latest/gr/sigv4_signing.html|Signature Version 4}\n*\n* @class Signer\n*/\n\n\nvar Signer =\n/** @class */\nfunction () {\n  function Signer() {}\n\n  Signer.sign = sign;\n  return Signer;\n}();\n\nexports.Signer = Signer;\nexports.default = Signer;","map":null,"metadata":{},"sourceType":"script"}